---
phase: 01-constellation-scene
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/constellation/scene/HoverLabel.jsx
  - src/constellation/scene/CameraController.jsx
  - src/constellation/ui/DetailPanel.jsx
  - src/constellation/ui/DetailPanel.css
  - src/constellation/ui/TimelineScrubber.jsx
  - src/constellation/ui/TimelineScrubber.css
  - src/constellation/ui/Toolbar.jsx
  - src/constellation/ui/Toolbar.css
  - src/constellation/ui/MediaLightbox.jsx
  - src/constellation/ui/MediaLightbox.css
  - src/constellation/ui/EntityChip.jsx
  - src/pages/ConstellationPage.jsx
  - src/pages/ConstellationPage.css
  - src/constellation/scene/ConstellationCanvas.jsx
  - src/constellation/scene/NodeCloud.jsx
  - src/constellation/store.js
autonomous: false
requirements:
  - REND-02
  - REND-03
  - REND-04
  - REND-07
  - REND-11

must_haves:
  truths:
    - "User can hover any node to see a 3D billboard label showing the node title (REND-02)"
    - "User can click any node to trigger a smooth 1.5s camera fly-to, then see a detail panel slide in from the right showing title, type, date, description, media, entity chips, and connection reasons"
    - "User can drag a vertical timeline scrubber to move the camera along the helix with epoch labels visible"
    - "User can press ESC to close detail panel (first) then exit constellation (second press), and browser back button works at every layer"
    - "User can click Home/Reset button to fly back to initial camera position and clear all focus state"
  artifacts:
    - path: "src/constellation/scene/HoverLabel.jsx"
      provides: "Drei Text + Billboard for 3D hover tooltip"
    - path: "src/constellation/scene/CameraController.jsx"
      provides: "GSAP fly-to animation + auto-orbit pause/resume + idle timer"
    - path: "src/constellation/ui/DetailPanel.jsx"
      provides: "Right sidebar detail panel with title, text, media, entity chips, Because section"
    - path: "src/constellation/ui/TimelineScrubber.jsx"
      provides: "Vertical rail scrubber with epoch labels"
    - path: "src/constellation/ui/Toolbar.jsx"
      provides: "Home/Reset button and 3D/2D toggle"
    - path: "src/constellation/ui/MediaLightbox.jsx"
      provides: "Full-screen media overlay with arrow key navigation"
  key_links:
    - from: "src/constellation/scene/CameraController.jsx"
      to: "src/constellation/store.js"
      via: "Zustand focusedNodeId subscription triggers fly-to"
      pattern: "useConstellationStore.*focusedNodeId"
    - from: "src/constellation/ui/DetailPanel.jsx"
      to: "src/constellation/store.js"
      via: "Zustand focusedNodeId drives panel content"
      pattern: "useConstellationStore.*focusedNodeId"
    - from: "src/constellation/ui/TimelineScrubber.jsx"
      to: "src/constellation/scene/CameraController.jsx"
      via: "Store timelinePosition triggers camera repositioning along helix"
      pattern: "setTimelinePosition"
    - from: "src/pages/ConstellationPage.jsx"
      to: "window.history"
      via: "popstate listener for layered back-button behavior"
      pattern: "addEventListener.*popstate"
---

<objective>
Wire up all user interaction: hover labels, click-to-fly camera animation, detail panel with media/entities/connections, timeline scrubber, toolbar, lightbox, and layered ESC/back-button navigation.

Purpose: Transform the static scene from Plan 01 into an interactive, explorable experience. This plan covers the core user journey: hover -> click -> read -> navigate timeline -> exit.

Output: Fully interactive constellation with hover tooltips, camera fly-to, rich detail panel, timeline navigation, media lightbox, and clean exit behavior.
</objective>

<execution_context>
@C:/Users/rowej/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rowej/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-constellation-scene/01-CONTEXT.md
@.planning/phases/01-constellation-scene/01-RESEARCH.md
@.planning/phases/01-constellation-scene/01-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 (must exist before this plan runs) -->

From src/constellation/store.js:
```jsx
import { create } from 'zustand'
export const useConstellationStore = create((set, get) => ({
  viewMode: '3d' | '2d',
  gpuTier: null | number,
  focusedNodeId: null | string,
  hoveredNodeIdx: null | number,
  filterEntity: null | { type, value },
  lightboxMedia: null | array,
  lightboxIndex: 0,
  timelinePosition: 0, // 0-1 normalized

  setViewMode, setGpuTier, focusNode, clearFocus,
  setHoveredNode, setFilterEntity, clearFilter,
  openLightbox, closeLightbox, setTimelinePosition,
}))
```

From src/constellation/layout/helixLayout.js:
```jsx
export function computeHelixLayout(nodes, config) → [{ ...node, x, y, z }]
export function getHelixCenter(positions) → { x, y, z }
export function getHelixBounds(positions) → { minY, maxY }
```

From src/constellation/data/mock-constellation.json:
```json
{
  "nodes": [{ "id", "type", "title", "date", "epoch", "description", "media": [], "connections": [], "size", "isHub" }],
  "edges": [{ "source", "target", "weight", "evidence": [{ "type", "signal", "description" }] }],
  "epochs": [{ "name", "startDate", "endDate" }]
}
```

From src/constellation/scene/ConstellationCanvas.jsx:
```jsx
// Exposes controlsRef for OrbitControls
// Renders NodeCloud, Starfield, NebulaFog inside Canvas
// Has conditional EffectComposer + Bloom
```

From src/constellation/scene/NodeCloud.jsx:
```jsx
// InstancedMesh with onClick(e.instanceId), onPointerOver, onPointerOut
// Reads hoveredNodeIdx and focusedNodeId from store
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hover labels, camera fly-to controller, toolbar, and timeline scrubber</name>
  <files>
    src/constellation/scene/HoverLabel.jsx
    src/constellation/scene/CameraController.jsx
    src/constellation/ui/Toolbar.jsx
    src/constellation/ui/Toolbar.css
    src/constellation/ui/TimelineScrubber.jsx
    src/constellation/ui/TimelineScrubber.css
    src/constellation/scene/ConstellationCanvas.jsx
    src/constellation/scene/NodeCloud.jsx
    src/constellation/store.js
    src/pages/ConstellationPage.jsx
    src/pages/ConstellationPage.css
  </files>
  <action>
**Step 1: Create HoverLabel.jsx** at `src/constellation/scene/HoverLabel.jsx`

Drei `<Text>` inside `<Billboard>` for 3D hover tooltip:
- Subscribe to `hoveredNodeIdx` from store
- If null, return null (no label)
- Position at hovered node's xyz + slight Y offset (node.size + 1.5 above)
- Drei `<Billboard follow={true}>` containing single `<Text>` child:
  - Title only: `<Text fontSize={1.2} color="white" anchorX="center" anchorY="bottom" outlineWidth={0.05} outlineColor="black">`
- Display title only per locked UX decision (clean, fast — type and date visible in detail panel on click)
- Render inside Canvas tree (is a 3D component)

**Step 2: Create CameraController.jsx** at `src/constellation/scene/CameraController.jsx`

Manages camera fly-to, auto-orbit pause/resume, and timeline-driven camera position:
- Accept `controlsRef` prop (ref to OrbitControls)
- Accept `positions` prop (layout-computed node positions)
- Accept `helixBounds` prop (`{ minY, maxY }`)
- Import `useConstellationStore` from `../store`. Use a `useEffect` that subscribes to `focusedNodeId` from the store (via `useConstellationStore(s => s.focusedNodeId)`) and triggers the fly-to animation whenever `focusedNodeId` changes. This is the KEY LINK that connects node clicks to camera movement.
- When `focusedNodeId` changes to a non-null ID:
  1. Find the node in positions by ID
  2. Compute camera target: node position
  3. Compute camera position: offset from node (e.g., node.x + 15, node.y + 5, node.z + 15 -- looking at node from above-right)
  4. Pause auto-rotate (`controls.autoRotate = false`)
  5. GSAP `timeline().to(camera.position, { x, y, z, duration: 1.5, ease: 'power2.inOut', onUpdate: () => controls.update() }, 0).to(controls.target, { x: node.x, y: node.y, z: node.z, duration: 1.5, ease: 'power2.inOut' }, 0)`
  6. CRITICAL: Animate BOTH camera.position AND controls.target simultaneously (per pitfall #2 in research)
- When `focusedNodeId` changes to null (clearFocus):
  1. Animate back to initial camera position (store initial position on mount)
  2. Resume auto-rotate after animation completes
- Auto-orbit pause/resume (from existing globe pattern in research):
  - Listen for OrbitControls 'start' event: pause auto-rotate, clear idle timer
  - Listen for OrbitControls 'end' event: set 5-second idle timer, then resume with speed ramp (0 -> 0.5 over 25 frames at 50ms)
- Timeline-driven camera: Subscribe to `timelinePosition` from store.
  - Map `t` (0-1) to helix Y position: `helixBounds.minY + t * (helixBounds.maxY - helixBounds.minY)`
  - GSAP animate camera to: `{ x: 0, y: mappedY, z: 80 }` with short duration (0.3s)
  - Update controls.target to `{ x: 0, y: mappedY, z: 0 }`

**Step 3: Create Toolbar.jsx** at `src/constellation/ui/Toolbar.jsx`

React DOM overlay (not 3D) positioned top-right:
- Home/Reset button: Icon button (House or RotateCcw from lucide-react). On click: `store.clearFocus()` (which triggers CameraController to fly back to initial position)
- 3D/2D toggle: Two-state toggle button. Shows current mode. On click: `store.setViewMode(mode === '3d' ? '2d' : '3d')`. Persists to localStorage.
- Style: Glass panel aesthetic matching existing site (`.glass-panel` pattern). `position: absolute; top: 1rem; right: 1rem; z-index: 10;`

**Step 4: Create TimelineScrubber.jsx** at `src/constellation/ui/TimelineScrubber.jsx`

Vertical rail scrubber (v1 -- spiral minimap deferred per CONTEXT.md):
- React DOM overlay positioned on the right side of the viewport
- Vertical track (2px wide, 60vh tall) with draggable thumb
- Epoch labels alongside the track at proportional positions (computed from epoch date ranges vs total date range)
- Year markers as small ticks
- Drag interaction: pointer down on thumb -> pointermove updates `store.setTimelinePosition(normalizedY)` -> pointerup releases
- Click on track: jump to that position
- Style: Semi-transparent glass aesthetic, subtle glow on active epoch
- Position: `position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); z-index: 10;`
- Hide when detail panel is open (to avoid overlap)

**Step 5: Update NodeCloud.jsx** to implement focus dimming

When `focusedNodeId` is set:
- Find the focused node and its connected node IDs (from edges in mock data)
- Set opacity of non-connected nodes to 0.15 (per locked decision: "~15% opacity ghost")
- Set focused node emissiveIntensity higher (brighter glow)
- Connected nodes stay at full opacity
- Update `InstancedBufferAttribute` for opacity + set `needsUpdate = true`
- When `focusedNodeId` is null, restore all opacities to 1.0

When `filterEntity` is set (from entity chip click):
- Find all nodes connected to that entity
- Dim non-matching nodes to 0.15
- "Clear filter" handled by Toolbar or store.clearFilter()

**Step 6: Update ConstellationCanvas.jsx**

- Add `<HoverLabel>` and `<CameraController>` as children of Canvas
- Pass `controlsRef`, `positions`, `helixBounds` to CameraController

**Step 7: Update ConstellationPage.jsx and CSS**

- Add Toolbar, TimelineScrubber as DOM overlays (siblings of Canvas, not inside Canvas)
- Wire ESC key handler (detailed in Task 2)
- Add CSS for toolbar and scrubber positioning
  </action>
  <verify>
    <automated>cd C:/dev/jarowe && npx vite build 2>&1 | tail -5 && echo "--- Wiring checks ---" && node -e "const fs=require('fs'); const cc=fs.readFileSync('src/constellation/scene/ConstellationCanvas.jsx','utf8'); const ok1=cc.includes('HoverLabel'); const ok2=cc.includes('CameraController'); console.log('HoverLabel in Canvas:', ok1); console.log('CameraController in Canvas:', ok2); if(!ok1||!ok2) process.exit(1);" && node -e "const fs=require('fs'); const cam=fs.readFileSync('src/constellation/scene/CameraController.jsx','utf8'); const ok=cam.includes('focusedNodeId') && cam.includes('useConstellationStore'); console.log('CameraController subscribes to focusedNodeId:', ok); if(!ok) process.exit(1);" && node -e "const fs=require('fs'); const s=fs.readFileSync('src/constellation/store.js','utf8'); const exports=['focusNode','clearFocus','setHoveredNode','setTimelinePosition','setViewMode']; const missing=exports.filter(e=>!s.includes(e)); console.log('Store exports check - missing:', missing.length?missing:'none'); if(missing.length) process.exit(1);"</automated>
  </verify>
  <done>
    - Hovering a node shows 3D billboard text label with node title (REND-02)
    - Clicking a node triggers smooth 1.5s GSAP camera fly-to
    - CameraController subscribes to focusedNodeId from useConstellationStore and triggers fly-to animation
    - HoverLabel and CameraController are wired into ConstellationCanvas
    - Non-connected nodes dim to ~15% opacity on focus
    - Home/Reset button flies camera back and clears focus
    - 3D/2D toggle persists preference to localStorage
    - Timeline scrubber drags to move camera along helix with epoch labels
    - Auto-orbit pauses on interaction, resumes after 5s idle with speed ramp
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Detail panel, media lightbox, entity chips, and ESC/back navigation</name>
  <files>
    src/constellation/ui/DetailPanel.jsx
    src/constellation/ui/DetailPanel.css
    src/constellation/ui/MediaLightbox.jsx
    src/constellation/ui/MediaLightbox.css
    src/constellation/ui/EntityChip.jsx
    src/pages/ConstellationPage.jsx
  </files>
  <action>
**Step 1: Create DetailPanel.jsx** at `src/constellation/ui/DetailPanel.jsx`

Right sidebar slide-in panel (React DOM, not 3D):
- Subscribe to `focusedNodeId` from store. If null, panel is hidden (slide out).
- Find focused node data from mock constellation.json by ID
- Find edges where source or target matches focused node ID
- Content hierarchy (top to bottom, per locked decision):
  1. **Header**: Title (h2) + type badge (colored pill matching node type color) + date (formatted)
  2. **Description**: Node description text
  3. **Media gallery**: If node has media array, show thumbnail grid. Click thumbnail -> `store.openLightbox(node.media, index)`. Use `import.meta.env.BASE_URL` for image paths. For mock data, use placeholder images or colored rectangles.
  4. **Entity chips**: Extract unique entities from connected edges (people, places, tags). Render as `<EntityChip>` components with count badges showing connected node count. E.g., "Jake (7)" meaning 7 nodes connected through Jake.
  5. **"Because..." section**: Expandable/collapsible (collapsed by default). For each edge connected to this node, show evidence reasons from `edge.evidence` array. Format: evidence type icon + description.
- Animation: Use Framer Motion `AnimatePresence` + `motion.div` for slide-in from right. `initial={{ x: '100%' }}`, `animate={{ x: 0 }}`, `exit={{ x: '100%' }}`, transition duration 0.3s ease.
- Close button: X icon (top-right of panel). On click: `store.clearFocus()`
- Width: 350px on desktop (per locked decision)
- Style: Glass panel background (`rgba(10,10,20,0.85)` + `backdrop-filter: blur(12px)`), matching site aesthetic.

**Step 2: Create DetailPanel.css**

- `.detail-panel { position: absolute; right: 0; top: 0; bottom: 0; width: 350px; z-index: 20; overflow-y: auto; ... }`
- `.detail-panel__header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }`
- `.detail-panel__type-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; text-transform: uppercase; }`
- Type badge colors matching node palette
- Entity chip section, media grid, Because section styles
- Mobile responsive: `@media (max-width: 768px)` -> bottom sheet instead of sidebar:
  - `.detail-panel { right: unset; left: 0; top: unset; bottom: 0; width: 100%; height: 50vh; border-radius: 1rem 1rem 0 0; }` (per locked decision: "bottom sheet half-screen")
  - Use Framer Motion drag for pull-up gesture: `drag="y"` with `dragConstraints` for half-screen and full-screen snap points

**Step 3: Create EntityChip.jsx** at `src/constellation/ui/EntityChip.jsx`

Small clickable chip component:
- Props: `{ type, label, count, onClick }`
- Render: colored pill with label + count badge (e.g., "Jake (7)")
- Color: based on entity type (person=violet, place=teal, tag=gray)
- On click: call `store.setFilterEntity({ type, value: label })` (per locked decision: "Clicking a chip filters the constellation")
- Hover: slight scale + brightness increase

**Step 4: Create MediaLightbox.jsx** at `src/constellation/ui/MediaLightbox.jsx`

Full-screen media overlay:
- Subscribe to `lightboxMedia` and `lightboxIndex` from store
- If `lightboxMedia === null`, return null
- Full-screen overlay: `position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.9);`
- Display current media item (image). For mock data, show placeholder colored rectangle with "Image N" text.
- Arrow buttons (left/right) + keyboard arrow keys to navigate. Wrap around at ends.
- ESC closes lightbox (returns to detail panel, NOT constellation -- per locked decision)
- Close button (X) in top-right
- Animation: Framer Motion `AnimatePresence` fade in/out

**Step 5: Create MediaLightbox.css**

- Overlay positioning, image sizing (max-width: 90vw, max-height: 90vh, object-fit: contain)
- Arrow button styling, close button styling

**Step 6: Wire layered ESC/back-button navigation in ConstellationPage.jsx**

ESC key handler (`useEffect` with keydown listener):
- Layer 1: If lightbox open -> `store.closeLightbox()` (closes lightbox, panel stays)
- Layer 2: If detail panel open (focusedNodeId !== null) -> `store.clearFocus()` (closes panel)
- Layer 3: If nothing open -> navigate away from constellation (`navigate(-1)` via React Router)

Browser back button (popstate handler):
- Use `history.pushState` when first node is focused (push one entry)
- Use `history.replaceState` for subsequent node-to-node navigation (per pitfall #7 in research -- avoid stack overflow)
- On popstate:
  - Layer 1: If lightbox open -> close lightbox
  - Layer 2: If panel open -> clear focus, remove constellation state
  - Layer 3: Navigate away via `navigate(-1)`
- Track `hasConstellationState` ref to avoid duplicate pushState calls

REND-11 implementation: ESC and back button exit cleanly at every layer with no broken state.
  </action>
  <verify>
    <automated>cd C:/dev/jarowe && npx vite build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Detail panel slides in from right showing title, type badge, date, description, media thumbnails, entity chips, and Because section
    - Entity chips show count badges and filter constellation on click
    - Media lightbox opens on thumbnail click with arrow key navigation
    - ESC closes lightbox first, then panel, then exits constellation
    - Browser back button handles all layers without stack overflow
    - Home/Reset clears focus and flies back
    - Mobile: panel renders as bottom sheet
    - Build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify interactive constellation experience</name>
  <what-built>
    Full interactive constellation scene with:
    - 150+ nodes in double-helix layout with hover tooltips
    - Camera fly-to on click with detail panel showing node info
    - Timeline scrubber for helix navigation
    - Media lightbox overlay
    - Layered ESC and back-button behavior
    - Auto-orbit with idle resume
    - Focus dimming (non-connected nodes ghost)
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` and visit http://localhost:5173/constellation
    2. **Hover test**: Move mouse over nodes -- 3D text label should appear showing the node title only (clean, minimal)
    3. **Click test**: Click any node -- camera should smoothly fly to it (~1.5s), detail panel should slide in from right
    4. **Panel content**: Panel shows title + type badge + date + description + entity chips + "Because..." section (collapsed)
    5. **Entity chip filter**: Click an entity chip -- non-matching nodes should dim. Click "Clear filter" to restore.
    6. **Timeline scrubber**: Drag the vertical scrubber on the right -- camera should move along the helix. Epoch labels should be visible.
    7. **Home/Reset**: Click the Home button -- camera flies back to initial position, panel closes.
    8. **ESC**: Focus a node (panel open). Press ESC -- panel closes. Press ESC again -- leaves constellation.
    9. **Back button**: Focus a node. Click browser back -- panel closes. Click back again -- leaves constellation. Should NOT require many clicks.
    10. **Auto-orbit**: Stop interacting for 5+ seconds -- orbit rotation should resume smoothly.
    11. **Mobile**: Resize browser to mobile width -- detail panel should be a bottom sheet instead of right sidebar.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All hover/click/fly-to interactions work smoothly
2. Detail panel shows correct content for clicked node
3. Timeline scrubber moves camera along helix
4. ESC key handles layered dismissal correctly
5. Browser back button doesn't create stack overflow
6. Auto-orbit pause/resume with 5s idle timer
7. Mobile bottom sheet renders correctly
8. Focus dimming works (non-connected nodes at ~15% opacity)
9. Media lightbox opens/closes with arrow key navigation
10. Build passes, no console errors
</verification>

<success_criteria>
- Hover any node -> 3D billboard label appears
- Click any node -> 1.5s fly-to + detail panel with title/type/date/description/media/entities/Because
- Drag timeline scrubber -> camera follows helix
- ESC: lightbox > panel > exit (layered)
- Back button: lightbox > panel > exit (no stack overflow)
- Home/Reset: fly back + clear focus
- Mobile: bottom sheet panel
- Auto-orbit resumes after 5s idle
</success_criteria>

<output>
After completion, create `.planning/phases/01-constellation-scene/01-02-SUMMARY.md`
</output>

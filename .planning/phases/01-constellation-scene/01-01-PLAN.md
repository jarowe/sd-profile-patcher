---
phase: 01-constellation-scene
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constellation/store.js
  - src/constellation/data/mock-constellation.json
  - src/constellation/layout/helixLayout.js
  - src/constellation/scene/ConstellationCanvas.jsx
  - src/constellation/scene/NodeCloud.jsx
  - src/constellation/scene/Starfield.jsx
  - src/constellation/scene/NebulaFog.jsx
  - src/pages/ConstellationPage.jsx
  - src/pages/ConstellationPage.css
  - src/App.jsx
autonomous: true
requirements:
  - REND-01
  - REND-06
  - REND-10
  - REND-12

must_haves:
  truths:
    - "User visits /constellation and sees 150+ glowing spheres arranged in a recognizable double-helix shape against a deep space background"
    - "Scene maintains 60fps on desktop with all effects enabled"
    - "On low-tier GPU (mobile), effects degrade gracefully -- no bloom, no particles, no nebula -- without crashing"
    - "Navigating away from /constellation and back does not leak GPU memory (geometry/texture count stable)"
  artifacts:
    - path: "src/constellation/store.js"
      provides: "Zustand store for constellation UI state"
      exports: ["useConstellationStore"]
    - path: "src/constellation/data/mock-constellation.json"
      provides: "Mock data with 150+ nodes across 6 types and 5+ epochs"
      contains: "nodes, edges, epochs"
    - path: "src/constellation/layout/helixLayout.js"
      provides: "Double-helix layout algorithm"
      exports: ["computeHelixLayout"]
    - path: "src/constellation/scene/ConstellationCanvas.jsx"
      provides: "R3F Canvas with EffectComposer, OrbitControls, GPU tier detection"
    - path: "src/constellation/scene/NodeCloud.jsx"
      provides: "InstancedMesh rendering 150+ node spheres"
    - path: "src/pages/ConstellationPage.jsx"
      provides: "Route entry point at /constellation"
  key_links:
    - from: "src/App.jsx"
      to: "src/pages/ConstellationPage.jsx"
      via: "React.lazy + Route path=/constellation"
      pattern: "React\\.lazy.*ConstellationPage"
    - from: "src/constellation/scene/NodeCloud.jsx"
      to: "src/constellation/store.js"
      via: "useConstellationStore selector"
      pattern: "useConstellationStore"
    - from: "src/constellation/scene/ConstellationCanvas.jsx"
      to: "@react-three/postprocessing"
      via: "EffectComposer + Bloom"
      pattern: "EffectComposer.*Bloom"
---

<objective>
Set up the 3D constellation scene foundation: R3F Canvas with instanced node rendering, double-helix layout, background atmosphere, GPU tier adaptive degradation, and disposal utilities.

Purpose: Establish the core rendering pipeline that all subsequent interaction and UI plans build upon. This is the "can we render 150+ glowing spheres at 60fps" proof.

Output: A visitable /constellation route showing 150+ colored, glowing, pulsing spheres in a double-helix arrangement against a deep space starfield, with proper GPU disposal on unmount.
</objective>

<execution_context>
@C:/Users/rowej/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rowej/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-constellation-scene/01-CONTEXT.md
@.planning/phases/01-constellation-scene/01-RESEARCH.md

<interfaces>
<!-- Existing project interfaces this plan integrates with -->

From src/App.jsx:
```jsx
// Lazy-loading pattern (follow UniversePage pattern):
const UniversePage = React.lazy(() => import('./pages/UniversePage'));
// Route pattern:
<Route path="/universe" element={<Suspense fallback={...}><UniversePage /></Suspense>} />
```

From src/context/AudioContext.jsx:
```jsx
export function AudioProvider({ children }) { ... }
export const useAudio = () => useContext(AudioContext);
// AudioProvider wraps Router in App.jsx
```

From src/utils/sounds.js:
```jsx
export const playHoverSound = () => { ... };
export const playClickSound = () => { ... };
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zustand, create store, mock data, and helix layout</name>
  <files>
    src/constellation/store.js
    src/constellation/data/mock-constellation.json
    src/constellation/layout/helixLayout.js
  </files>
  <action>
**Step 1: Install Zustand**
```bash
npm install zustand
```

**Step 2: Create Zustand store** at `src/constellation/store.js`

Use `create` from `zustand`. Store slices:
- `viewMode`: `'3d'` | `'2d'` (default from `localStorage.getItem('constellation-view') || '3d'`). `setViewMode(mode)` saves to localStorage.
- `gpuTier`: `null` initially. `setGpuTier(tier)` sets once on mount.
- `focusedNodeId`: `null`. `focusNode(id)` sets it. `clearFocus()` resets to null + clears filterEntity.
- `hoveredNodeIdx`: `null`. `setHoveredNode(idx)` sets it.
- `filterEntity`: `null`. `setFilterEntity(entity)` sets it. `clearFilter()` resets.
- `panelOpen`: derived from `focusedNodeId !== null`.
- `lightboxMedia`: `null`, `lightboxIndex`: `0`. `openLightbox(media, index)`, `closeLightbox()`.
- `timelinePosition`: `0` (0-1 normalized). `setTimelinePosition(t)`.

Export as `useConstellationStore`.

**Step 3: Create mock constellation data** at `src/constellation/data/mock-constellation.json`

Generate 150+ nodes covering all 6 types:
- ~30 projects (type: "project", color: amber)
- ~40 moments (type: "moment", color: coral)
- ~25 people (type: "person", color: violet)
- ~20 places (type: "place", color: teal)
- ~20 ideas (type: "idea", color: cyan)
- ~15+ milestones (type: "milestone", color: gold)

Each node: `{ id, type, title, date, epoch, description, media: [], connections: [], size (0.5-2.0), isHub (bool) }`.

Distribute across 5+ epochs: "Early Years" (2005-2010), "College" (2010-2014), "Career Start" (2014-2018), "Growth" (2018-2022), "Present" (2022-2026). Hub nodes (isHub: true, size: 1.5-2.0) for milestones and key people. Leaf nodes (size: 0.5-1.0).

Each edge: `{ source, target, weight (0.0-1.0), evidence: [{ type, signal, description }] }`. Create 200+ edges. Evidence types: "person", "client", "place", "tag", "temporal".

Include realistic-sounding titles (e.g., "Launched Carbonmade Redesign", "Orlando Trip with Family", "Met Jake at Conference", "Austin, TX", "Design Systems Manifesto").

**Step 4: Create helix layout algorithm** at `src/constellation/layout/helixLayout.js`

Export `computeHelixLayout(nodes, config)`:
- Config: `{ radius: 30, pitch: 5, epochGap: 15, jitterRadius: 2, seed: 42 }`
- Sort nodes by date
- Group by epoch (use `node.epoch` field)
- For each epoch: increment currentY by epochGap (except first)
- Within epoch: distribute nodes along helix parametrically:
  - `t = (i / epochNodes.length) * Math.PI * 2`
  - strand = `node.isHub ? 0 : (i % 2)` (hubs on strand 0)
  - `angle = t + strand * Math.PI`
  - `x = radius * cos(angle) + seededJitter`
  - `y = currentY + (i / epochNodes.length) * pitch`
  - `z = radius * sin(angle) + seededJitter`
- Use seeded PRNG (simple mulberry32) for deterministic jitter
- Return array of `{ ...node, x, y, z }`
- Also export `getHelixCenter(positions)` returning the midpoint Vector3 for camera targeting
- Also export `getHelixBounds(positions)` returning `{ minY, maxY }` for timeline scrubber mapping

Do NOT use `Math.random()` -- use seeded PRNG for deterministic positions across sessions.
  </action>
  <verify>
    <automated>cd C:/dev/jarowe && node -e "const z = require('zustand'); console.log('zustand OK')" 2>&1 || echo "zustand not installed" && node -e "const d = require('./src/constellation/data/mock-constellation.json'); console.log('Nodes:', d.nodes.length, 'Edges:', d.edges.length)" 2>&1 || echo "mock data issue"</automated>
  </verify>
  <done>
    - Zustand installed and importable
    - Store exports useConstellationStore with all slices
    - Mock data has 150+ nodes across 6 types, 200+ edges with evidence arrays, 5+ epochs
    - Helix layout produces deterministic x/y/z positions for all nodes
    - No Math.random() used (seeded PRNG only)
  </done>
</task>

<task type="auto">
  <name>Task 2: Build R3F Canvas scene with instanced nodes, starfield, nebula, bloom, and disposal</name>
  <files>
    src/constellation/scene/ConstellationCanvas.jsx
    src/constellation/scene/NodeCloud.jsx
    src/constellation/scene/Starfield.jsx
    src/constellation/scene/NebulaFog.jsx
    src/pages/ConstellationPage.jsx
    src/pages/ConstellationPage.css
    src/App.jsx
  </files>
  <action>
**Step 1: Create ConstellationCanvas.jsx** at `src/constellation/scene/ConstellationCanvas.jsx`

R3F `<Canvas>` wrapper containing:
- `<Canvas gl={{ antialias: true }} camera={{ position: [0, centerY, 80], fov: 60 }} dpr={gpuConfig.dpr} onCreated={({ gl }) => { rendererRef.current = gl }}>` where centerY is the helix vertical midpoint
- `<OrbitControls>` from Drei with:
  - `autoRotate={true}`, `autoRotateSpeed={0.5}`, `enableDamping={true}`, `dampingFactor={0.05}`
  - `enablePan={false}` (locked decision: no panning)
  - `minPolarAngle={Math.PI * 15/180}`, `maxPolarAngle={Math.PI * 165/180}` (locked: 15-165 degrees)
  - `minDistance={40}`, `maxDistance={120}` (moderate zoom range -- cluster-level, not node-level)
  - Store ref in `controlsRef` for GSAP fly-to (Plan 02)
- GPU tier detection: Call `useDetectGPU()` from Drei at Canvas level. Feed tier into store via `setGpuTier()`. Create `useGPUConfig()` hook that returns tier-based config object:
  - Tier 0-1 (LOW): `{ bloom: false, pulseAnimation: false, starParticles: 0, nebulaFog: false, dpr: 1, sphereSegments: 8 }`
  - Tier 2 (MEDIUM): `{ bloom: true, pulseAnimation: true, starParticles: 4000, nebulaFog: false, dpr: 1.5, sphereSegments: 12 }`
  - Tier 3 (HIGH): `{ bloom: true, pulseAnimation: true, starParticles: 8000, nebulaFog: true, dpr: 2, sphereSegments: 16 }`
- Conditional `<EffectComposer>` (only if `gpuConfig.bloom`):
  - `<Bloom luminanceThreshold={1} luminanceSmoothing={0.9} intensity={0.5} mipmapBlur />`
- Scene children: `<NodeCloud>`, `<Starfield>`, `<NebulaFog>` (conditional), `<ambientLight intensity={0.15} />`
- Disposal: `useEffect` cleanup that logs `renderer.info.memory.geometries` and `renderer.info.memory.textures` to console on unmount. R3F handles auto-disposal of children; manual disposal only for any module-scope resources.

IMPORTANT: `useDetectGPU` must be called INSIDE the Canvas tree (it needs WebGL context). Place it in a child component (e.g., `GPUDetector`) that sets the store tier on mount.

**Step 2: Create NodeCloud.jsx** at `src/constellation/scene/NodeCloud.jsx`

Native `<instancedMesh>` (NOT Drei `<Instances>`) rendering all nodes:
- Import mock data and run through `computeHelixLayout()` via `useMemo`
- Create shared `<sphereGeometry args={[1, gpuConfig.sphereSegments, gpuConfig.sphereSegments]} />`
- Use `<meshStandardMaterial emissive="white" emissiveIntensity={1.5} toneMapped={false} vertexColors />`
- `InstancedBufferAttribute` for per-instance colors (from node type palette):
  - project: `#f59e0b` (amber)
  - moment: `#f87171` (coral)
  - person: `#a78bfa` (violet)
  - place: `#2dd4bf` (teal)
  - idea: `#22d3ee` (cyan)
  - milestone: `#fbbf24` (gold)
- `InstancedBufferAttribute` for per-instance opacity (default 1.0, used for focus dimming in Plan 02)
- Set transform matrices via `dummy.position.set(x, y, z)` + `dummy.scale.setScalar(node.size)` + `setMatrixAt()`
- After setting all matrices: `instanceMatrix.needsUpdate = true` + `computeBoundingSphere()`
- Breathing pulse animation (if `gpuConfig.pulseAnimation`): In `useFrame`, update a `time` uniform or modulate emissiveIntensity via a custom shader chunk. Use `sin(time * 0.5 + instanceIndex * 0.3)` for per-node phase offset. Scale range: 0.95-1.05 (subtle).
- Wire `onClick` and `onPointerOver`/`onPointerOut` events with `e.stopPropagation()`:
  - `onClick`: Call `store.focusNode(nodes[e.instanceId].id)` (actual fly-to in Plan 02)
  - `onPointerOver`: Call `store.setHoveredNode(e.instanceId)`, set `document.body.style.cursor = 'pointer'`
  - `onPointerOut`: Call `store.setHoveredNode(null)`, reset cursor

**Step 3: Create Starfield.jsx** at `src/constellation/scene/Starfield.jsx`

Background twinkling stars using Drei `<Stars>` or custom `<Points>`:
- If gpuConfig.starParticles === 0, return null
- Use Drei `<Stars radius={200} depth={100} count={gpuConfig.starParticles} factor={4} saturation={0} fade speed={1} />`
- Or custom Points with twinkling via InstancedBufferAttribute opacity animated in useFrame
- Position outside the helix radius (radius: 200+) so they feel like deep space background
- Keep intensity low (stars should NOT trigger bloom -- no emissiveIntensity > 1.0)

**Step 4: Create NebulaFog.jsx** at `src/constellation/scene/NebulaFog.jsx`

Subtle nebula haze near epoch cluster cores:
- If gpuConfig.nebulaFog === false, return null
- For each epoch center position, render a few semi-transparent sprite billboards with soft color gradients
- Use `<Billboard>` from Drei with `<meshBasicMaterial transparent opacity={0.03-0.08} color={epochColor} side={THREE.FrontSide} depthWrite={false} />`
- Scale: 20-40 units diameter (large, soft blobs)
- Colors: warm tones near older epochs, cooler near recent
- CRITICAL: Do NOT use FrontSide atmosphere meshes with AdditiveBlending (per MEMORY.md). Use standard blending with very low opacity.

**Step 5: Create ConstellationPage.jsx** at `src/pages/ConstellationPage.jsx`

Route entry component:
- Full viewport container (`width: 100vw, height: 100vh, position: relative, overflow: hidden, background: #050505`)
- Conditionally render `<ConstellationCanvas>` (if viewMode === '3d') or placeholder `<div>2D fallback coming in Plan 03</div>` (if viewMode === '2d')
- Read `viewMode` from store
- Loading state: Show "Initializing Constellation..." centered text while Canvas mounts

**Step 6: Create ConstellationPage.css** at `src/pages/ConstellationPage.css`

- `.constellation-page { width: 100vw; height: 100vh; position: relative; overflow: hidden; background: #050505; }`
- `.constellation-loading { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); font-size: 1rem; }`

**Step 7: Register route in App.jsx**

Add lazy import and route (follow UniversePage pattern):
```jsx
const ConstellationPage = React.lazy(() => import('./pages/ConstellationPage'));
// In Routes:
<Route path="/constellation" element={
  <Suspense fallback={<div style={{ color: 'white', padding: '2rem', textAlign: 'center' }}>Loading Constellation...</div>}>
    <ConstellationPage />
  </Suspense>
} />
```

IMPORTANT: Do NOT modify any existing routes. Only ADD the new /constellation route.
  </action>
  <verify>
    <automated>cd C:/dev/jarowe && npx vite build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - /constellation route is registered and lazy-loaded in App.jsx
    - ConstellationCanvas renders R3F scene with OrbitControls, conditional Bloom, ambient light
    - NodeCloud renders 150+ instanced spheres in double-helix layout with correct type colors
    - Nodes have breathing pulse animation on high-tier GPUs
    - Starfield renders twinkling background stars (tier-dependent count)
    - NebulaFog renders subtle haze near epoch cores (tier 3 only)
    - GPU tier detection sets store tier on mount
    - Orbit controls: 15-165 polar clamp, no panning, auto-rotate at 0.5 speed
    - Console logs geometry/texture count on unmount (disposal verification)
    - Vite build succeeds without errors
  </done>
</task>

</tasks>

<verification>
1. Run `npm run dev` and visit `http://localhost:5173/constellation`
2. Verify 150+ colored spheres visible in a double-helix shape
3. Verify spheres glow with bloom effect (on capable GPU)
4. Verify starfield background visible
5. Verify auto-orbit rotation
6. Verify orbit controls: drag to orbit, scroll to zoom, no panning, vertical clamp prevents upside-down
7. Navigate away and back -- check console for geometry/texture disposal counts
8. Open DevTools Performance tab, verify 60fps
</verification>

<success_criteria>
- /constellation renders 150+ instanced spheres in double-helix layout at 60fps
- Spheres colored by type (amber, coral, violet, teal, cyan, gold)
- Bloom glow on nodes (tier 2-3), breathing pulse (tier 2-3)
- Deep space starfield background (tier 2-3)
- Subtle nebula fog near epoch cores (tier 3)
- Auto-orbit rotation, clamped polar angle, no pan
- GPU disposal logged on unmount
- Vite build passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-constellation-scene/01-01-SUMMARY.md`
</output>

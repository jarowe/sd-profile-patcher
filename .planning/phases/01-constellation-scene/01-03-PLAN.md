---
phase: 01-constellation-scene
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/constellation/scene/ConnectionLines.jsx
  - src/constellation/ui/DetailPanel.jsx
  - src/constellation/fallback/ListView.jsx
  - src/constellation/fallback/ListView.css
  - src/pages/ConstellationPage.jsx
  - src/pages/ConstellationPage.css
  - src/constellation/scene/ConstellationCanvas.jsx
autonomous: false
requirements:
  - REND-05
  - REND-08
  - REND-09

must_haves:
  truths:
    - "User sees thin luminous connection lines between related nodes, with lines brightening on focus and non-connected lines fading"
    - "User can expand 'Because...' section in detail panel to see 3-5 evidence reasons for each connection"
    - "User can switch to a 2D list view with search, type filter, keyboard navigation (tab/arrow/enter), and detail panel content for each row"
    - "User on a device that cannot render 3D is auto-prompted to switch to 2D, with toggle persisted in localStorage"
  artifacts:
    - path: "src/constellation/scene/ConnectionLines.jsx"
      provides: "Drei Line components for all edges with focus-aware opacity"
    - path: "src/constellation/fallback/ListView.jsx"
      provides: "2D accessible list view with search, filter, keyboard nav"
    - path: "src/constellation/fallback/ListView.css"
      provides: "Styles for 2D list view"
  key_links:
    - from: "src/constellation/scene/ConnectionLines.jsx"
      to: "src/constellation/store.js"
      via: "focusedNodeId subscription controls line opacity"
      pattern: "useConstellationStore.*focusedNodeId"
    - from: "src/constellation/fallback/ListView.jsx"
      to: "src/constellation/store.js"
      via: "focusNode(id) on row click opens detail panel"
      pattern: "focusNode"
    - from: "src/pages/ConstellationPage.jsx"
      to: "src/constellation/fallback/ListView.jsx"
      via: "viewMode === '2d' conditional render"
      pattern: "viewMode.*2d"
---

<objective>
Add connection lines between nodes, enhance the "Because..." evidence display, build the 2D accessible fallback list view, and finalize mobile responsiveness and cross-device support.

Purpose: Complete the constellation experience with visual connections (the "why" behind relationships), ensure accessibility via 2D fallback, and polish for all device tiers. This plan delivers the remaining REND requirements.

Output: Luminous connection lines with focus-aware opacity, rich "Because..." evidence in detail panel, fully accessible 2D list view with search/filter/keyboard nav, and auto-detect prompt for weak devices.
</objective>

<execution_context>
@C:/Users/rowej/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rowej/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-constellation-scene/01-CONTEXT.md
@.planning/phases/01-constellation-scene/01-RESEARCH.md
@.planning/phases/01-constellation-scene/01-01-SUMMARY.md
@.planning/phases/01-constellation-scene/01-02-SUMMARY.md

<interfaces>
<!-- From Plans 01 + 02 -->

From src/constellation/store.js:
```jsx
export const useConstellationStore = create((set, get) => ({
  viewMode: '3d' | '2d',
  gpuTier: null | number,
  focusedNodeId: null | string,
  hoveredNodeIdx: null | number,
  filterEntity: null | { type, value },
  // ... other slices
  focusNode, clearFocus, setViewMode, setFilterEntity, clearFilter,
}))
```

From src/constellation/layout/helixLayout.js:
```jsx
export function computeHelixLayout(nodes, config) â†’ [{ ...node, x, y, z }]
```

From src/constellation/data/mock-constellation.json:
```json
{
  "nodes": [{ "id", "type", "title", "date", "epoch", "description", "media": [], "connections": [], "size", "isHub" }],
  "edges": [{ "source", "target", "weight", "evidence": [{ "type", "signal", "description" }] }],
  "epochs": [{ "name", "startDate", "endDate" }]
}
```

From src/constellation/ui/DetailPanel.jsx (Plan 02):
```jsx
// Right sidebar with title, type badge, date, description, media, entity chips, Because section
// Because section is collapsed by default -- Plan 03 enhances the evidence rendering
```

From src/constellation/ui/Toolbar.jsx (Plan 02):
```jsx
// Has 3D/2D toggle button that calls store.setViewMode()
```

From src/pages/ConstellationPage.jsx (Plan 02):
```jsx
// Conditionally renders ConstellationCanvas (3D) or placeholder (2D)
// ESC/back-button handlers already wired
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Connection lines with focus-aware opacity and enhanced "Because..." display</name>
  <files>
    src/constellation/scene/ConnectionLines.jsx
    src/constellation/ui/DetailPanel.jsx
    src/constellation/scene/ConstellationCanvas.jsx
  </files>
  <action>
**Step 1: Create ConnectionLines.jsx** at `src/constellation/scene/ConnectionLines.jsx`

Render connection lines between related nodes:
- Import `Line` from `@react-three/drei`
- Import edges and layout-computed positions
- Subscribe to `focusedNodeId` and `filterEntity` from store
- For each edge in mock data:
  - Find source and target positions from layout
  - Determine line state: `active` (connected to focused node), `dimmed` (not connected), `normal` (no focus)
  - Render `<Line points={[sourcePos, targetPos]} color={lineColor} lineWidth={lineWidth} transparent opacity={lineOpacity} />`
- Line styling (per locked decisions):
  - Normal state: color white with low opacity (0.12), lineWidth 1 -- "thin luminous threads, subtle until node is focused"
  - Active state (connected to focused node): opacity 0.8, lineWidth 1.5 -- "connected lines brighten"
  - Dimmed state (not connected to focused node): opacity 0.03 -- "non-connected lines fade"
  - Use `toneMapped={false}` on line material for bloom glow on active lines
- Performance: If total visible edges > 100, consider batching. Start with individual `<Line>` components per research recommendation. Profile and batch into single `LineSegments2` only if draw call count becomes a problem.
- When `filterEntity` is set, show only edges that involve the filtered entity (check evidence array for matching entity type/value). Dim all others.

CRITICAL: Lines must use emissive colors with `toneMapped={false}` for bloom to work on them. Set `emissive` or use a material that goes above luminanceThreshold.

NOTE on Drei `<Line>`: It uses `LineMaterial` which may not support `emissive`. If bloom doesn't work on lines, switch to thin `<mesh>` tubes with `<meshStandardMaterial emissive toneMapped={false}>` or accept non-glowing lines (they'll still be luminous via high RGB values).

**Step 2: Enhance "Because..." section in DetailPanel.jsx**

The detail panel already has a collapsed "Because..." section from Plan 02. Enhance it:
- For the focused node, collect all edges where source or target matches the node ID
- For each connected edge, display:
  - Connected node title (link-like text, clicking it calls `store.focusNode(connectedNodeId)`)
  - Evidence reasons from `edge.evidence` array. Each evidence item:
    - Icon based on evidence type (person icon, map pin, tag, clock for temporal)
    - Signal weight as subtle indicator (e.g., thin colored bar or percentage)
    - Description text
  - Show 3-5 evidence items per connection (per REND-08: "3-5 evidence reasons")
- Collapsible section: Click "Because..." header to expand/collapse. Default collapsed. Use Framer Motion `AnimatePresence` for smooth expand.
- If many connections (>5), show first 5 with "Show N more connections" expand button.

**Step 3: Update ConstellationCanvas.jsx**

- Add `<ConnectionLines>` as a child of Canvas, passing positions and edges data
- Ensure ConnectionLines renders BEHIND NodeCloud in the scene (add before NodeCloud in JSX order, or use `renderOrder`)
  </action>
  <verify>
    <automated>cd C:/dev/jarowe && npx vite build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Connection lines visible between nodes as thin luminous threads
    - Lines brighten when connected to focused node, fade when not connected
    - Lines respond to entity filter (only relevant connections visible)
    - "Because..." section shows 3-5 evidence reasons per connection with icons and descriptions
    - Clicking connected node name in Because section flies to that node
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: 2D accessible list fallback with search, filter, and keyboard navigation</name>
  <files>
    src/constellation/fallback/ListView.jsx
    src/constellation/fallback/ListView.css
    src/pages/ConstellationPage.jsx
    src/pages/ConstellationPage.css
  </files>
  <action>
**Step 1: Create ListView.jsx** at `src/constellation/fallback/ListView.jsx`

Pure React DOM component (NO Three.js dependency):
- Load mock constellation data (same JSON as 3D view)
- **Search**: Text input at top. Filters nodes by title, type, epoch, or tag match. Debounce input 200ms.
- **Type filter**: Row of type pills (All, Projects, Moments, People, Places, Ideas, Milestones). Click to filter by type. "All" shows everything.
- **Node list**: Scrollable list sorted by date (newest first by default, sortable by date/type/title).
  - Each row: title, type badge (colored pill), date (formatted), connection count
  - Row is focusable and clickable
  - Click row: call `store.focusNode(node.id)` -- this opens the same DetailPanel from Plan 02
  - Selected row: highlighted with accent border
- **Keyboard navigation** (per locked decision: "Fully keyboard-navigable"):
  - `role="listbox"` on list container
  - Each row: `role="option"`, `aria-selected={isSelected}`, `tabIndex={0 for active, -1 for others}`
  - Arrow Up/Down: Move selection through list
  - Enter: Focus selected node (opens detail panel)
  - Tab: Move between search input, filter pills, and list
  - Home/End: Jump to first/last item in list
- **Accessibility**:
  - `aria-label="Constellation node list"` on container
  - `aria-live="polite"` region announcing result count changes
  - Visible focus indicators (outline or ring)
  - All interactive elements keyboard-reachable
- **Sorting**: Small dropdown or button group: "Date (newest)", "Date (oldest)", "Type", "Title (A-Z)"

**Step 2: Create ListView.css**

- `.list-view { padding: 1rem; max-width: 800px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }`
- `.list-view__search { ... }` -- search input styling with glass panel aesthetic
- `.list-view__filters { ... }` -- horizontal scrollable filter pills
- `.list-view__row { ... }` -- row with hover state, selected state, focus ring
- `.list-view__type-badge { ... }` -- colored pills matching 3D node colors
- Use existing site CSS variables (--accent-primary, --bg-dark, etc.)
- Mobile responsive: stack filters vertically on narrow screens

**Step 3: Update ConstellationPage.jsx**

- Import ListView
- When `viewMode === '2d'`: render `<ListView />` + `<DetailPanel />` + `<MediaLightbox />`
- When `viewMode === '3d'`: render `<ConstellationCanvas />` + DOM overlays (already implemented)
- Detail panel works in both modes (same component, reads same store state)
- **Auto-detect prompt**: On initial mount, if `gpuTier <= 1` AND no localStorage preference exists:
  - Show a toast/prompt: "Your device may have trouble with 3D. Switch to List View?"
  - "Switch to List" button calls `store.setViewMode('2d')`
  - "Keep 3D" dismisses and saves preference
  - Only show once (track in localStorage key `constellation-autodetect-dismissed`)

**Step 4: Update ConstellationPage.css**

- Add styles for auto-detect prompt (positioned toast, glass panel)
- Ensure both 3D and 2D views fill viewport correctly
- In 2D mode, detail panel is a right sidebar on desktop and bottom sheet on mobile (same responsive behavior as 3D mode)

**Step 5: Final polish for REND-09 compliance**

- Verify tab order flows: search -> filters -> list rows -> detail panel
- Verify screen reader announces: "N results found" when search/filter changes
- Verify Enter on a list row opens detail panel with correct content
- Verify ESC closes detail panel in 2D mode (same handler works)
  </action>
  <verify>
    <automated>cd C:/dev/jarowe && npx vite build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - 2D list view renders when viewMode is '2d'
    - Search input filters nodes by title/type/epoch/tag
    - Type filter pills work (All, Projects, Moments, etc.)
    - Clicking a row opens the detail panel with correct node content
    - Keyboard navigation: arrow keys move selection, enter opens panel, tab cycles focus areas
    - ARIA roles and live regions properly announce state changes
    - Auto-detect prompt appears for tier 0-1 GPUs on first visit
    - Toggle preference persisted to localStorage
    - Detail panel works identically in both 3D and 2D modes
    - Build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Final Phase 1 verification -- complete constellation experience</name>
  <what-built>
    Complete Phase 1 constellation scene with:
    - 150+ nodes in double-helix layout at 60fps
    - Connection lines between nodes (luminous threads, focus-aware opacity)
    - Hover tooltips, click-to-fly, detail panel with media/entities/Because
    - Timeline scrubber for helix navigation
    - "Because..." evidence lens with 3-5 reasons per connection
    - 2D accessible list fallback with search, filter, keyboard nav
    - Mobile responsive (bottom sheet panel, touch gestures, GPU degradation)
    - Layered ESC/back-button navigation
    - GPU disposal on unmount
  </what-built>
  <how-to-verify>
    **3D Experience:**
    1. Visit http://localhost:5173/constellation -- 150+ colored spheres in double-helix, connection lines visible
    2. Hover nodes -- 3D text label appears
    3. Click a node -- camera flies to it, connected lines brighten, non-connected fade, detail panel slides in
    4. In panel: verify title + type badge + date + description + entity chips + "Because..." section
    5. Expand "Because..." -- should show 3-5 evidence reasons per connection with icons
    6. Click a connected node name in Because -- should fly to that node
    7. Click an entity chip -- constellation filters to show connected nodes
    8. Drag timeline scrubber -- camera moves along helix
    9. Press Home/Reset -- flies back to overview, clears focus
    10. Test ESC layering: open lightbox (if media exists) -> ESC closes lightbox -> ESC closes panel -> ESC leaves page
    11. Test back button: same layering, should NOT require many clicks

    **2D Fallback:**
    12. Click 3D/2D toggle -- switches to list view
    13. Type in search box -- list filters
    14. Click type pills -- list filters by type
    15. Use arrow keys to navigate list, Enter to select
    16. Verify detail panel opens with correct content
    17. Tab through interactive elements (search -> filters -> list -> panel)

    **Mobile:**
    18. Resize browser to ~375px width -- panel should be a bottom sheet
    19. Verify touch gestures work (drag orbit, pinch zoom, tap to focus)

    **Performance:**
    20. Open DevTools Performance tab, verify 60fps in 3D mode
    21. Navigate away from /constellation and back -- check console for disposal logs
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Connection lines render as luminous threads between nodes
2. Lines brighten/fade correctly based on focus state
3. "Because..." section shows 3-5 evidence reasons per connection
4. 2D list view has search, filter, keyboard nav, and ARIA roles
5. Auto-detect prompt appears for weak GPUs
6. Toggle persists to localStorage
7. Both 3D and 2D modes share the same detail panel
8. Complete ESC/back-button layering works in both modes
9. Build passes, no console errors
10. Full Phase 1 success criteria met (all 6 from roadmap)
</verification>

<success_criteria>
- Connection lines: thin luminous threads, focus-aware opacity, bloom glow on active
- "Because..." lens: 3-5 evidence reasons per connection, clickable connected node names
- 2D fallback: search, type filter, keyboard-navigable list, ARIA compliant
- Auto-detect prompt for tier 0-1 GPU devices
- Mobile: touch gestures, bottom sheet panel, GPU degradation
- All REND-01 through REND-12 requirements satisfied
- 60fps on desktop, no memory leaks on navigation
</success_criteria>

<output>
After completion, create `.planning/phases/01-constellation-scene/01-03-SUMMARY.md`
</output>

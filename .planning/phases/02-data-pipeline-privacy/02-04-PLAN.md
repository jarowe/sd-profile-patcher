---
phase: 02-data-pipeline-privacy
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - pipeline/privacy/visibility.mjs
  - pipeline/privacy/minors-guard.mjs
  - pipeline/validation/privacy-audit.mjs
  - pipeline/validation/schema-validator.mjs
  - pipeline/index.mjs
  - allowlist.json
  - curation.json
autonomous: true
requirements: [PRIV-01, PRIV-02, PRIV-05, PRIV-06, PRIV-07, PRIV-08]

must_haves:
  truths:
    - "Build FAILS with exit code 1 if any private-tier node appears in public output"
    - "Minors have no last names, no GPS data, no school/home identifiers in any output"
    - "DMs, contact graphs, and close friends lists never appear in output (scanned and blocked)"
    - "People are visible publicly only if explicitly on the allowlist -- otherwise labeled 'Friend'/'Family'/'Collaborator'"
    - "The privacy audit scans the COMPLETE final JSON output, not just individual nodes (belt-and-suspenders)"
    - "GPS coordinates in output never exceed 2 decimal places for public content"
    - "Visibility assignment is a TWO-PHASE process: parsers set defaults (Instagram=private, Carbonmade=public), then this plan REFINES those defaults via allowlist enforcement, curation overrides, and most-restrictive-wins logic"
  artifacts:
    - path: "pipeline/privacy/visibility.mjs"
      provides: "Visibility tier REFINEMENT and allowlist enforcement (second phase of two-phase visibility)"
      exports: ["assignVisibility", "applyAllowlist"]
    - path: "pipeline/privacy/minors-guard.mjs"
      provides: "Minors policy enforcement"
      exports: ["enforceMinorsPolicy", "isMinor"]
    - path: "pipeline/validation/privacy-audit.mjs"
      provides: "Fail-closed privacy audit of complete output"
      exports: ["auditPrivacy"]
    - path: "pipeline/validation/schema-validator.mjs"
      provides: "JSON Schema validation of output against constellation schema"
      exports: ["validateSchema"]
    - path: "allowlist.json"
      provides: "People allowlist for public visibility"
    - path: "curation.json"
      provides: "Node publish/hide state (READ-ONLY input to pipeline)"
  key_links:
    - from: "pipeline/validation/privacy-audit.mjs"
      to: "pipeline/index.mjs"
      via: "auditPrivacy() called as final step before write, process.exit(1) on violations"
      pattern: "process\\.exit\\(1\\)"
    - from: "pipeline/privacy/visibility.mjs"
      to: "allowlist.json"
      via: "fs.readFile to load allowlist"
      pattern: "allowlist\\.json"
    - from: "pipeline/privacy/minors-guard.mjs"
      to: "pipeline/privacy/gps-redactor.mjs"
      via: "isMinor flag passed to redactGPS"
      pattern: "isMinor"
    - from: "pipeline/index.mjs"
      to: "pipeline/validation/privacy-audit.mjs"
      via: "Final audit step before emit"
      pattern: "auditPrivacy"
---

<objective>
Implement fail-closed privacy validation, visibility tier REFINEMENT, minors policy, and allowlist system.

Purpose: Privacy is the critical safety net for the entire pipeline. This plan performs the SECOND PHASE of visibility assignment: parsers (Plans 01/02) set source-level defaults (Instagram=private, Carbonmade=public), and this plan REFINES those defaults by applying allowlist enforcement, curation overrides, minors policy, and the most-restrictive-wins rule. The build MUST fail (exit code 1) if any privacy violation is detected. This is the "belt and suspenders" layer -- even if parsers make mistakes, the privacy audit catches it.

Output: `pipeline/privacy/visibility.mjs`, `pipeline/privacy/minors-guard.mjs`, `pipeline/validation/privacy-audit.mjs`, `pipeline/validation/schema-validator.mjs`, updated `pipeline/index.mjs`, `allowlist.json`, `curation.json`
</objective>

<execution_context>
@C:\Users\rowej\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rowej\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-pipeline-privacy/02-CONTEXT.md
@.planning/phases/02-data-pipeline-privacy/02-RESEARCH.md
@.planning/phases/02-data-pipeline-privacy/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Visibility tier refinement, allowlist, and minors guard</name>
  <files>
    pipeline/privacy/visibility.mjs
    pipeline/privacy/minors-guard.mjs
    allowlist.json
    curation.json
  </files>
  <action>
    **TWO-PHASE VISIBILITY APPROACH:**
    Phase 1 (already done in Plans 01/02): Parsers set source-level defaults:
      - Instagram parser: all nodes default to visibility="private" (personal content, most restrictive by default)
      - Carbonmade parser: all nodes default to visibility="public" (published portfolio work)
    Phase 2 (THIS plan): Refine those defaults via:
      - Allowlist enforcement (unknown people cap visibility at "friends")
      - Curation overrides (admin publish/hide decisions from curation.json)
      - Minors policy (special restrictions per PRIV-05)
      - Most-restrictive-wins rule (if multiple rules apply, the most restrictive tier wins)

    Create `allowlist.json` (version-controlled, initial template):
    ```json
    {
      "_comment": "People allowed to appear publicly by name. Everyone else is labeled generically.",
      "public": [],
      "friends": [],
      "minors": {
        "firstNames": [],
        "blockedPatterns": []
      }
    }
    ```
    - `public`: Array of names that can appear with full attribution publicly (e.g., collaborators, public figures)
    - `friends`: Array of names visible to friends-tier but not public
    - `minors.firstNames`: First names of minors (for tagging OK, but no last names/GPS/school)
    - `minors.blockedPatterns`: Strings that must not appear near minor references (school names, home addresses, etc.)

    Create `curation.json` (version-controlled, READ-ONLY input to pipeline):
    ```json
    {
      "_comment": "Node curation state. Pipeline reads this to apply publish/hide. Managed via admin UI. Pipeline NEVER writes to this file.",
      "hidden": [],
      "visibility_overrides": {}
    }
    ```
    - `hidden`: Array of node IDs to exclude from output
    - `visibility_overrides`: { [nodeId]: "public" | "friends" | "private" } for per-node overrides
    - IMPORTANT: curation.json is READ-ONLY input to the pipeline. Pipeline runtime status goes to public/data/pipeline-status.json (created in Plan 03). The admin UI (Plan 05) reads both files but only modifies curation.json.

    Create `pipeline/privacy/visibility.mjs`:
    - Export `assignVisibility(node, allowlist, curationOverrides)`:
      - Start with node's current visibility (set by parser in Phase 1: "private" for Instagram, "public" for Carbonmade)
      - Apply curation override if exists for this node ID (from curation.json visibility_overrides)
      - Apply allowlist precedence (LOCKED: most restrictive rule wins):
        - If node mentions people NOT on any allowlist -> node visibility capped at "friends" (can't be public with uncleared names)
        - If node mentions minors -> special handling (see minors-guard)
        - If explicitly on curation override -> use that, UNLESS allowlist would be more restrictive
      - Return final visibility tier string ("public", "friends", or "private" -- exactly 3 tiers per user decision)
    - Export `applyAllowlist(nodes, allowlist)`:
      - For each node, check entities.people against allowlist
      - People NOT on allowlist.public: replace their name with generic label:
        - If in allowlist.friends -> keep name but mark node as "friends" visibility
        - If not in any list -> replace name with "Friend" / "Family" / "Collaborator" based on context (default: "Friend")
      - Return modified nodes array
    - Export `filterPrivateNodes(nodes)`:
      - Remove all nodes with visibility === "private" from output
      - Log count of filtered nodes

    Create `pipeline/privacy/minors-guard.mjs`:
    - Export `isMinor(name, allowlist)`: Check if name appears in allowlist.minors.firstNames (case-insensitive)
    - Export `enforceMinorsPolicy(node, allowlist)`:
      - Check if any entity person is a minor
      - If minor is referenced:
        - Strip any last names from the node's title and description (replace with first name only)
        - Remove GPS data entirely (set location to null)
        - Check title + description against blockedPatterns (school names, home identifiers). If found, redact the pattern to "[redacted]".
        - Mark node._isMinor = true (for privacy audit to verify)
      - Return modified node
    - LOCKED per PRIV-05: First names OK, no last names, no GPS, no school/home identifiers for minors
  </action>
  <verify>
    Run `node -e "import('./pipeline/privacy/visibility.mjs').then(m => console.log(m.assignVisibility({visibility:'public',entities:{people:['Unknown Person']}}, {public:[], friends:[], minors:{firstNames:[],blockedPatterns:[]}}, {})))"` -- should return "friends" (unknown person caps visibility).
    Verify allowlist.json and curation.json are valid JSON: `node -e "JSON.parse(require('fs').readFileSync('allowlist.json','utf8'))"`.
    Verify curation.json does NOT have last_pipeline_run or pipeline_stats fields (those go in pipeline-status.json).
    Run `node -e "import('./pipeline/privacy/minors-guard.mjs').then(m => console.log(m.isMinor('Jace', {public:[],friends:[],minors:{firstNames:['Jace'],blockedPatterns:[]}})))"` -- should return true.
  </verify>
  <done>
    Visibility REFINEMENT enforces most-restrictive-wins rule on top of parser defaults (Phase 1: Instagram=private, Carbonmade=public; Phase 2: this plan refines via allowlist + curation overrides). Allowlist controls public name visibility. Minors guard strips last names, GPS, and blocked patterns. Curation.json is a clean READ-ONLY input template. All privacy utilities export correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Privacy audit, schema validation, and pipeline integration</name>
  <files>
    pipeline/validation/privacy-audit.mjs
    pipeline/validation/schema-validator.mjs
    pipeline/index.mjs
  </files>
  <action>
    Create `pipeline/validation/privacy-audit.mjs`:
    - Export `auditPrivacy(graph, config)`: Scans the COMPLETE output JSON (not individual nodes) for privacy violations.
    - Checks (per requirements):
      1. **PRIV-02**: No private-tier nodes in output (visibility === "private" should have been filtered)
      2. **PRIV-03**: GPS coordinates have <= 2 decimal places on ALL nodes. Use regex on stringified coordinates: check that decimal part has at most 2 digits.
      3. **PRIV-05**: Minor nodes (._isMinor === true) have: no GPS data (location must be null), no patterns matching blockedPatterns in title/description.
      4. **PRIV-06**: Output string must not contain "direct_messages", "close_friends", "contact_graph", "message_requests", "story_likes" patterns (DMs, contact graphs, close friends must never appear).
      5. **PRIV-07**: Check entities.people arrays -- any name not on the public allowlist that appears with full first+last format is a violation.
      6. No EXIF GPS data in output media paths (verify media files if they exist in public/data/media/).
    - Returns { violations: string[], warnings: string[] }
    - CRITICAL: If violations.length > 0, the pipeline MUST exit with code 1. This is non-negotiable per user decision.

    Create `pipeline/validation/schema-validator.mjs`:
    - Export `validateSchema(graph, layout)`:
      - Use ajv to validate graph JSON against a JSON Schema:
        - nodes: array of objects with required fields [id, type, title, date, epoch]
        - edges: array of objects with required fields [source, target, weight, evidence]
        - epochs: array of objects with required fields [id, label, range, color]
      - Validate layout JSON against schema:
        - positions: object with string keys and {x,y,z} values
        - helixParams: object with radius, pitch, epochGap, jitterRadius, seed
        - bounds: { minY, maxY }
      - Return { valid: boolean, errors: string[] }

    Update `pipeline/index.mjs` to integrate privacy and validation:
    - After parse phase: Apply visibility REFINEMENT to all nodes (assignVisibility) -- this is Phase 2 of the two-phase approach, refining the parser defaults from Plans 01/02
    - After visibility: Apply allowlist name processing (applyAllowlist)
    - After allowlist: Apply minors guard (enforceMinorsPolicy) to all nodes
    - After minors: Filter private nodes (filterPrivateNodes) -- remove from output
    - After emit: Run schema validation (validateSchema). If invalid, exit 1.
    - After schema: Run privacy audit (auditPrivacy). If violations found, log each violation, then process.exit(1).
    - Write pipeline-status.json with success/failure status and stats (NOT curation.json -- curation.json is read-only input)
    - Pipeline exit codes: 0 = success, 1 = privacy violation or schema error, 2 = no data (empty pipeline)

    The privacy audit MUST be the LAST step before declaring success. No writing should occur after the audit passes except the pipeline-status.json stats update.

    Actual pipeline execution order after this plan:
    1. Parse (Instagram + Carbonmade) -- parsers set default visibility
    2. Assign visibility tiers (REFINE parser defaults via allowlist + curation overrides)
    3. Apply allowlist (name redaction for non-public people)
    4. Apply minors guard
    5. Filter private nodes
    6. EXIF strip + GPS redact (from Plan 01)
    7. Generate edges
    8. Compute layout
    9. Build output JSON
    10. Schema validation (fail on invalid)
    11. Privacy audit (FAIL-CLOSED on any violation)
    12. Write output files (constellation.graph.json, constellation.layout.json)
    13. Write pipeline-status.json with run stats
  </action>
  <verify>
    Run `node pipeline/index.mjs` -- should complete with exit code 0 if all privacy checks pass.
    Verify privacy audit runs: Check console output for "[pipeline:privacy-audit] Scanning output..." log line.
    Test fail-closed: Temporarily inject a private node into the output (modify a node's visibility to "private" after filtering) and verify pipeline exits with code 1. Then revert.
    Verify pipeline-status.json (NOT curation.json) is updated with run timestamp and stats after successful run.
    Verify curation.json is UNCHANGED by pipeline execution (compare before/after).
    Verify no GPS coordinates in output have > 2 decimal places: `node -e "const g = JSON.parse(require('fs').readFileSync('public/data/constellation.graph.json','utf8')); g.nodes.forEach(n => { if(n.location?.lat) { const d = String(n.location.lat).split('.')[1]; if(d && d.length > 2) console.error('GPS VIOLATION', n.id, n.location); } }); console.log('GPS check passed');"`.
  </verify>
  <done>
    Privacy audit scans complete output and fails the build (exit code 1) if any violations are found. Schema validation ensures output matches expected structure. Pipeline integrates two-phase visibility (parser defaults + refinement via allowlist/curation/minors). Pipeline writes runtime status to pipeline-status.json (NOT curation.json). The build is fail-closed -- zero tolerance for privacy leaks.
  </done>
</task>

</tasks>

<verification>
- `node pipeline/index.mjs` completes with exit code 0 on clean data
- No private nodes in `public/data/constellation.graph.json` (grep for "private" visibility)
- No GPS coordinates with > 2 decimal places in output
- No DM/contact/close-friends patterns in output string
- pipeline-status.json updated with run stats after pipeline run
- curation.json UNCHANGED by pipeline execution (read-only input)
- allowlist.json and curation.json are valid JSON and version-controlled
- Pipeline exits with code 1 if a privacy violation is injected
</verification>

<success_criteria>
Privacy audit provides fail-closed guarantee. Build exits 1 on any leak. Two-phase visibility: parsers set defaults (Instagram=private, Carbonmade=public), this plan refines via allowlist + curation + minors policy with most-restrictive-wins. Minors protected per PRIV-05 (first names only, no GPS/school/home). People visible publicly only via explicit allowlist. DMs and contact graphs blocked. Schema validation catches structural issues. Pipeline status written to pipeline-status.json, NOT curation.json.
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-pipeline-privacy/02-04-SUMMARY.md`
</output>

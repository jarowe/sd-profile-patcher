---
phase: 02-data-pipeline-privacy
plan: 05
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - src/pages/Admin.jsx
  - src/pages/Admin.css
  - src/App.jsx
  - pipeline/index.mjs
  - .gitignore
  - .env.example
autonomous: false
requirements: [PIPE-07]

must_haves:
  truths:
    - "A thin admin page at /admin shows last pipeline run status (time, success/fail, node counts by source and type)"
    - "Admin page shows a table of all nodes with title, type, date, visibility tier, and a publish/hide toggle"
    - "Toggling publish/hide updates curation.json which the pipeline reads on next run"
    - "If pipeline data is missing, the admin page shows a clear 'No pipeline data yet' message and does not crash"
    - "Admin page is protected by a simple env-var auth gate (VITE_ADMIN_KEY)"
    - "If the pipeline fails or data is unavailable, the last good constellation.json is preserved (not overwritten with empty/broken data)"
  artifacts:
    - path: "src/pages/Admin.jsx"
      provides: "Thin admin page with pipeline status and node publish/hide controls"
    - path: "src/pages/Admin.css"
      provides: "Admin page styling"
    - path: ".env.example"
      provides: "Example environment variables including VITE_ADMIN_KEY"
  key_links:
    - from: "src/pages/Admin.jsx"
      to: "curation.json"
      via: "reads pipeline_stats and hidden list for display"
      pattern: "curation\\.json"
    - from: "src/pages/Admin.jsx"
      to: "public/data/constellation.graph.json"
      via: "fetches node list for display table"
      pattern: "constellation\\.graph"
    - from: "src/App.jsx"
      to: "src/pages/Admin.jsx"
      via: "lazy-loaded /admin route"
      pattern: "/admin"
    - from: "pipeline/index.mjs"
      to: "public/data/constellation.graph.json"
      via: "preserves last good output on failure"
      pattern: "lastGood|backup|preserve"
---

<objective>
Build thin admin page with pipeline status and publish/hide controls, plus pipeline resilience (last good snapshot preservation).

Purpose: This is the thin admin slice that de-risks Phase 4's full admin dashboard. It provides read-only visibility into the pipeline's health and basic curation controls (publish/hide per node). It also ensures pipeline resilience -- if the pipeline fails, the last good output is preserved.

Output: `src/pages/Admin.jsx`, `src/pages/Admin.css`, updated `src/App.jsx`, updated `pipeline/index.mjs`, `.gitignore` updates, `.env.example`
</objective>

<execution_context>
@C:\Users\rowej\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rowej\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-pipeline-privacy/02-CONTEXT.md
@.planning/phases/02-data-pipeline-privacy/02-RESEARCH.md
@.planning/phases/02-data-pipeline-privacy/02-04-SUMMARY.md
@src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pipeline resilience and admin route setup</name>
  <files>
    pipeline/index.mjs
    src/App.jsx
    .gitignore
    .env.example
  </files>
  <action>
    Update `pipeline/index.mjs` for resilience (PIPE-07):
    - Before starting the pipeline, check if valid output files already exist (public/data/constellation.graph.json). If so, read and store as "last good snapshot" in memory.
    - If the pipeline FAILS at any stage (parse error, privacy audit failure, schema validation failure):
      - Do NOT overwrite the existing output files
      - Log the failure clearly
      - Update curation.json with failure status (last_pipeline_run: timestamp, pipeline_stats: { status: "failed", error: "..." })
      - Exit with appropriate error code (1 for privacy, 2 for empty data)
      - The last good constellation.json remains intact for the frontend to serve
    - If the pipeline SUCCEEDS:
      - Write new output files (overwriting previous)
      - Update curation.json with success status and stats
    - Implementation: Wrap the emit phase in try/catch. Only write output files after ALL validation passes. Use a temporary file write pattern if needed (write to .tmp, then rename to final on success).

    Update `.gitignore`:
    - Add `public/data/` (generated build artifacts, NOT committed per user decision)
    - Add `data-private/` (Instagram export, never committed)
    - Add `.env.local` (dev secrets)
    - Keep `curation.json` and `allowlist.json` tracked (version-controlled per user decision)

    Create `.env.example`:
    ```
    # Admin authentication key (set in Vercel env vars for production)
    # In dev, copy to .env.local and set your own value
    VITE_ADMIN_KEY=your-secret-admin-key
    ```

    Update `src/App.jsx`:
    - Add lazy-loaded admin route: `const AdminPage = React.lazy(() => import('./pages/Admin'));`
    - Add route: `<Route path="/admin" element={<Suspense fallback={<div>Loading admin...</div>}><AdminPage /></Suspense>} />`
    - Follow existing pattern (same as UniversePage and ConstellationPage lazy loading)
  </action>
  <verify>
    Run `node pipeline/index.mjs` -- pipeline should still complete successfully.
    Verify curation.json has updated `last_pipeline_run` and `pipeline_stats` after run.
    Verify `.gitignore` includes `public/data/` and `data-private/`.
    Verify `.env.example` exists with VITE_ADMIN_KEY placeholder.
    Verify `src/App.jsx` has the /admin route with lazy loading.
    Test resilience: Run pipeline, verify output exists, then cause a failure (e.g., corrupt a required file temporarily), run pipeline again, verify original output files are NOT overwritten.
  </verify>
  <done>
    Pipeline preserves last good output on failure. .gitignore excludes generated data and private exports. Admin route is lazy-loaded at /admin. .env.example documents required environment variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Thin admin page with pipeline status and publish/hide controls</name>
  <files>
    src/pages/Admin.jsx
    src/pages/Admin.css
  </files>
  <action>
    Create `src/pages/Admin.jsx`:

    1. **Auth gate** (per user decision: simple env-var, Phase 4 replaces with GitHub OAuth):
       - Check `import.meta.env.VITE_ADMIN_KEY`
       - If not set, show "Admin disabled (no VITE_ADMIN_KEY configured)"
       - If set, show password input. On match, set authed=true in state.
       - Session-only auth (no localStorage persistence for admin -- security)

    2. **Pipeline status section** (read-only):
       - Fetch curation.json at mount (or fallback to showing "No pipeline data yet")
       - Display:
         - Last run: timestamp
         - Status: success/failed badge (green/red)
         - Node counts: total, by source (instagram/carbonmade), by type (milestone/project/moment/idea/place/person)
         - Edge count
         - Visibility breakdown: public/friends/private counts
       - If curation.json not found or empty, show "Pipeline has not been run yet" message

    3. **Node table** (per user decision: metadata table only, no thumbnails):
       - Fetch public/data/constellation.graph.json for the node list
       - Display table with columns: Title, Type, Source, Date, Epoch, Visibility, Published (toggle)
       - Sortable by any column (click header to sort)
       - Type filter pills above table (same pattern as ListView: milestone | project | moment | idea | place | person)
       - Search input to filter by title
       - Each row has a publish/hide toggle button (eye icon / eye-off icon from lucide-react)

    4. **Publish/hide toggle behavior**:
       - Toggling a node's visibility updates local state immediately (optimistic UI)
       - On toggle, update the curation data in state
       - Provide a "Save Changes" button that writes to curation.json
       - IMPORTANT: Since this is a client-side React app (no API server in Phase 2), the save mechanism has two options:
         a. **Dev mode**: Download updated curation.json for user to place in repo (simple, works now)
         b. **Future**: Phase 4 admin with API endpoint will handle this properly
       - Implement option (a): "Save Changes" button generates a curation.json download with the updated hidden[] array and visibility_overrides. User replaces the file in repo and re-runs pipeline.
       - Show clear instructions: "Download updated curation.json, replace in project root, and run `npm run pipeline` to apply changes."

    5. **Styling** (Admin.css):
       - Use existing glass-panel aesthetic from the site
       - Dark background matching constellation page
       - Table with alternating row colors for readability
       - Status badges: green for success, red for failed
       - Responsive: table scrolls horizontally on mobile
       - Keep it minimal -- this is a thin slice, not a full dashboard

    6. **Empty states**:
       - No pipeline data: "Pipeline has not been run yet. Run `npm run pipeline` to generate data."
       - No nodes: "No nodes found in constellation data."
       - Auth disabled: "Admin disabled. Set VITE_ADMIN_KEY in environment variables."

    IMPORTANT per user decision: No thumbnails, no editing, no curation UI beyond publish/hide. This is a READ-ONLY status view with a SINGLE toggle control. Phase 4 adds the rich admin experience.
  </action>
  <verify>
    Run `npm run dev` and visit `http://localhost:5173/admin` -- should show auth gate.
    Enter VITE_ADMIN_KEY (from .env.local) -- should see pipeline status and node table.
    If pipeline has been run, verify node counts match actual data.
    Verify publish/hide toggle updates local state.
    Verify "Save Changes" generates a downloadable curation.json.
    Verify page handles missing data gracefully (no crashes if pipeline hasn't been run).
    `npm run build` should succeed with the new admin page.
  </verify>
  <done>
    Thin admin page at /admin shows pipeline run status (last run, success/fail, node counts) and a metadata table with publish/hide toggles. Auth gate uses env-var key. Save mechanism downloads updated curation.json. Handles missing data gracefully. Styled with existing glass-panel aesthetic.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete data pipeline (Instagram + Carbonmade parsers, evidence-based edges, privacy enforcement, and thin admin page):
    1. Pipeline runs via `npm run pipeline` producing constellation.graph.json + constellation.layout.json
    2. Privacy audit fails the build if any violations detected
    3. Thin admin at /admin shows pipeline status and publish/hide controls
    4. Pipeline preserves last good output on failure
  </what-built>
  <how-to-verify>
    1. Run `npm run pipeline` and verify it completes successfully
    2. Check `public/data/constellation.graph.json` -- verify it has real Carbonmade data (projects, blog posts, milestones) with evidence-based edges
    3. Verify no private content in output: search for visibility "private" in the JSON
    4. Visit `http://localhost:5173/admin` -- enter admin key, verify pipeline status shows, node table displays
    5. Toggle a node's publish/hide, click Save, verify curation.json download
    6. Visit `http://localhost:5173/constellation` -- verify existing 3D scene still works with mock data (frontend migration not done yet)
    7. Run `npm run build` -- verify build succeeds (pipeline runs as prebuild)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- /admin route loads and shows auth gate
- Auth gate accepts VITE_ADMIN_KEY
- Pipeline status section shows last run info
- Node table displays all nodes from pipeline output
- Publish/hide toggle works and Save generates valid curation.json
- Pipeline preserves last good output on failure
- `npm run build` succeeds with prebuild pipeline step
- Existing constellation page still works (no regressions)
</verification>

<success_criteria>
Thin admin page provides read-only pipeline status and basic publish/hide controls. Pipeline resilience preserves last good output. The full Phase 2 pipeline is operational: parse real data, enforce privacy, generate edges, emit deterministic JSON, and fail-closed on any privacy violation.
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-pipeline-privacy/02-05-SUMMARY.md`
</output>

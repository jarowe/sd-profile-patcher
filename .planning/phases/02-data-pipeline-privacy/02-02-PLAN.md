---
phase: 02-data-pipeline-privacy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pipeline/parsers/carbonmade.mjs
  - pipeline/config/epochs.mjs
  - pipeline/config/pipeline-config.mjs
autonomous: true
requirements: [PIPE-02, PRIV-01]

must_haves:
  truths:
    - "Carbonmade JSON archive is parsed into canonical nodes: 35 projects as 'project' type, blog posts as 'moment'/'idea' type, and experience entries as 'milestone' type"
    - "Every node produced has a visibility tier (public/friends/private) assigned based on source defaults"
    - "Client names and collaborator mentions are extracted as entity references for edge generation"
    - "Epoch assignment is configurable and produces the same epoch labels as mock-constellation.json"
  artifacts:
    - path: "pipeline/parsers/carbonmade.mjs"
      provides: "Carbonmade JSON parser extracting projects, blog posts, experience milestones"
      exports: ["parseCarbonmade"]
    - path: "pipeline/config/epochs.mjs"
      provides: "Configurable epoch boundaries and assignment function"
      exports: ["assignEpoch", "EPOCH_CONFIG"]
    - path: "pipeline/config/pipeline-config.mjs"
      provides: "Central pipeline configuration (source dirs, output paths, defaults)"
      exports: ["PIPELINE_CONFIG"]
  key_links:
    - from: "pipeline/parsers/carbonmade.mjs"
      to: "pipeline/schemas/canonical.mjs"
      via: "createCanonicalNode() call for each project/blog/experience"
      pattern: "createCanonicalNode"
    - from: "pipeline/parsers/carbonmade.mjs"
      to: "pipeline/config/epochs.mjs"
      via: "assignEpoch(date) call for each node"
      pattern: "assignEpoch"
    - from: "pipeline/parsers/carbonmade.mjs"
      to: "carbonmade-archive/"
      via: "fs.readFile on project.json, blog.json, about.json"
      pattern: "carbonmade-archive"
---

<objective>
Parse Carbonmade JSON archive into canonical constellation nodes with visibility tiers and configurable epochs.

Purpose: This is the second data source. Carbonmade data is well-structured JSON (directly examined in research), so parsing is straightforward compared to Instagram HTML. This plan also creates the shared epoch configuration and pipeline config that both parsers use.

Output: `pipeline/parsers/carbonmade.mjs`, `pipeline/config/epochs.mjs`, `pipeline/config/pipeline-config.mjs`
</objective>

<execution_context>
@C:\Users\rowej\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rowej\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-pipeline-privacy/02-CONTEXT.md
@.planning/phases/02-data-pipeline-privacy/02-RESEARCH.md
@carbonmade-archive/about/about.json
@carbonmade-archive/blog/blog.json
@carbonmade-archive/projects/01-2019-Sizzle-Demo-Reel/project.json
@src/constellation/data/mock-constellation.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pipeline config and epoch assignment</name>
  <files>
    pipeline/config/epochs.mjs
    pipeline/config/pipeline-config.mjs
  </files>
  <action>
    Create `pipeline/config/epochs.mjs`:
    - Define EPOCH_CONFIG array matching mock-constellation.json epochs:
      ```
      [
        { id: "early-years", label: "Early Years", range: "2001-2010", color: "#fbbf24", start: 2001, end: 2010 },
        { id: "college", label: "College", range: "2010-2014", color: "#f59e0b", start: 2010, end: 2014 },
        { id: "career-start", label: "Career Start", range: "2014-2018", color: "#f87171", start: 2014, end: 2018 },
        { id: "growth", label: "Growth", range: "2018-2022", color: "#a78bfa", start: 2018, end: 2022 },
        { id: "present", label: "Present", range: "2022-2026", color: "#22d3ee", start: 2022, end: 2026 }
      ]
      ```
    - Note: These ranges are adjusted from mock (which used 2005-2010) to match actual Carbonmade career data (experience starts 2001 at AOTV). The Early Years range starts at 2001 to capture all data.
    - Export `assignEpoch(dateStr)`: Parse date string to year, find matching epoch by range (start <= year < end). If year < first epoch start, assign first epoch. If year >= last epoch end, assign last epoch. Returns epoch label string.
    - Export `getEpochConfig()`: Returns the full EPOCH_CONFIG array for inclusion in output JSON.

    Create `pipeline/config/pipeline-config.mjs`:
    - Export PIPELINE_CONFIG object with:
      - `sources.instagram.dir`: "data-private/instagram" (gitignored)
      - `sources.carbonmade.dir`: "carbonmade-archive" (already in repo)
      - `output.graphFile`: "public/data/constellation.graph.json"
      - `output.layoutFile`: "public/data/constellation.layout.json"
      - `output.mediaDir`: "public/data/media"
      - `curation.file`: "curation.json"
      - `allowlist.file`: "allowlist.json"
      - `privacy.gpsMaxDecimals`: 2
      - `privacy.defaultVisibility`: "private" (most restrictive by default per user decision)
      - `layout.radius`: 30, `layout.pitch`: 5, `layout.epochGap`: 15, `layout.jitterRadius`: 2, `layout.seed`: 42 (matching existing helixLayout defaults)
      - `determinism.seed`: 42
  </action>
  <verify>
    Run `node -e "import('./pipeline/config/epochs.mjs').then(m => console.log(m.assignEpoch('2015-06-15')))"` -- should print "Career Start".
    Run `node -e "import('./pipeline/config/epochs.mjs').then(m => console.log(m.assignEpoch('2003-01-01')))"` -- should print "Early Years".
    Run `node -e "import('./pipeline/config/pipeline-config.mjs').then(m => console.log(m.PIPELINE_CONFIG.output.graphFile))"` -- should print "public/data/constellation.graph.json".
  </verify>
  <done>
    Epoch config covers 2001-2026 in 5 epochs matching mock data. assignEpoch maps any date to the correct epoch. Pipeline config centralizes all paths and defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Carbonmade JSON parser</name>
  <files>
    pipeline/parsers/carbonmade.mjs
  </files>
  <action>
    Create `pipeline/parsers/carbonmade.mjs`:

    Export `parseCarbonmade(archiveDir)`:

    1. **Read manifest**: Load `{archiveDir}/manifest.json` to discover project count and site metadata. Log basic stats.

    2. **Parse projects** (35 expected): Discover all `{archiveDir}/projects/*/project.json` files using sortedGlob. For each:
       - Read project.json
       - Create canonical node with:
         - `id`: "cm-p-{sortedIndex}" (zero-padded 3 digits, e.g., "cm-p-001")
         - `type`: "project"
         - `title`: project.name or project.title
         - `date`: project.date (year string like "2019" -> "2019-01-01" for sorting)
         - `epoch`: assignEpoch(date)
         - `description`: project.description + texts[].text joined
         - `media`: project.imageUrls (CDN URLs) + local images/ paths as fallback. Note: media processing (EXIF strip) deferred to pipeline orchestration.
         - `size`: 1.0 for standard projects, 1.5 if videoStreams present (richer content = larger node)
         - `isHub`: true if project has both videos and 3+ images
         - `source`: "carbonmade"
         - `sourceId`: project.id (string numeric like "7151472")
         - `visibility`: "public" (Carbonmade portfolio is public work)
         - `entities.clients`: [project.for] if not "Jarowe" (self-published)
         - `entities.people`: Extract collaborator names from description text. Look for patterns like "alongside {Name}", "friend {Name}", "team: {Name}". Known collaborators from about.json can be cross-referenced.
         - `entities.tags`: Extract from project.type, project.role (split by bullet/ampersand/comma)
         - `entities.projects`: [project.name]

    3. **Parse blog posts** (31 in blog.json): Load `{archiveDir}/blog/blog.json`. For each post:
       - `id`: "cm-b-{sortedIndex}" (e.g., "cm-b-001")
       - `type`: "moment" for narrative posts, "idea" for short/philosophical posts (heuristic: <100 chars = "idea", else "moment")
       - `title`: First sentence of text (up to 80 chars) or "Blog: {date}"
       - `date`: Parse "Month DD, YYYY" format using date-fns parse("MMMM dd, yyyy")
       - `epoch`: assignEpoch(date)
       - `description`: Full text
       - `visibility`: "public"
       - `entities.people`: Extract mentioned names from text (look for capitalized name patterns adjacent to known context words)
       - `entities.tags`: Extract relevant tags from content (project names, tools, clients mentioned)

    4. **Parse experience/milestones**: Load `{archiveDir}/about/about.json`. For each experience entry:
       - `id`: "cm-m-{sortedIndex}" (e.g., "cm-m-001")
       - `type`: "milestone"
       - `title`: "{role} at {company}" (cleaned of HTML entities like &amp;)
       - `date`: Parse start date from details field (e.g., "July 2019" -> "2019-07-01")
       - `epoch`: assignEpoch(date)
       - `description`: experience.description (cleaned of HTML entities)
       - `size`: 1.5 (milestones are prominent)
       - `isHub`: true (career milestones anchor the timeline)
       - `visibility`: "public"
       - `entities.clients`: Extract client names from description
       - `entities.places`: Extract location from details field (e.g., "Orlando, FL")

    5. **Deduplication**: Within-source only by sourceId. Log any duplicates found.

    6. **Summary**: Return { nodes: CanonicalNode[], stats: { projects, blogPosts, milestones, total, warnings } }.

    IMPORTANT: Never modify files in carbonmade-archive/. It is read-only.
    IMPORTANT: Clean HTML entities (&amp; -> &, etc.) in all text fields.
    IMPORTANT: Handle missing/malformed JSON gracefully -- log warning, skip, continue.
  </action>
  <verify>
    Run `node -e "import('./pipeline/parsers/carbonmade.mjs').then(m => m.parseCarbonmade('./carbonmade-archive').then(r => console.log(r.stats)))"` -- should show projects: ~35, blogPosts: ~31, milestones: ~5.
    Verify a project node has correct shape: `node -e "import('./pipeline/parsers/carbonmade.mjs').then(m => m.parseCarbonmade('./carbonmade-archive').then(r => console.log(JSON.stringify(r.nodes[0], null, 2))))"` -- should have id, type "project", title, date, epoch, entities with clients.
    Verify milestone nodes are created from experience entries.
    Verify blog post dates parse correctly (e.g., "June 15, 2022" -> "2022-06-15").
  </verify>
  <done>
    Carbonmade parser produces ~70+ canonical nodes (35 projects + 31 blog posts + 5 milestones) from the existing archive. All nodes have visibility tiers assigned (public for portfolio content). Client names and collaborators extracted as entity references. Epoch assignment matches mock-constellation.json labels. All text cleaned of HTML entities.
  </done>
</task>

</tasks>

<verification>
- Carbonmade parser loads and produces nodes from the actual archive at `carbonmade-archive/`
- All nodes have required fields (id, type, title, date, epoch, visibility)
- Epoch assignment covers the full date range of Carbonmade data (2001-2026)
- Entity extraction captures client names from projects (e.g., "Sony PlayStation", "Google", "Disney")
- No files in carbonmade-archive/ are modified
- Blog post date parsing handles "Month DD, YYYY" format correctly
</verification>

<success_criteria>
Carbonmade parser extracts 35 projects, ~31 blog posts, and ~5 experience milestones into canonical nodes. Every node has a visibility tier. Epoch config produces matching labels. Pipeline config centralizes all path/default configuration. Parser is deterministic (same input = same output).
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-pipeline-privacy/02-02-SUMMARY.md`
</output>
